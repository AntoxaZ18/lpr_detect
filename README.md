# Описание
Этот проект направлен на детектирование номерных знаков автомобилей с использованием фреймворка YOLOv11,
а также проводит ablation study (анализ влияния различных компонентов модели).

# Содержание
- [Функции](#Функции)
- [Датасет](#Датасет)
- [Требования](#Требования)
- [Установка](#Установка)
- [Обучение](#Обучение)
- [Оценка](#Оценка)
- [Ablation Study](#Ablation-Study)
- [Экспорт ONNX](#Экспорт-ONNX)
- [Бенчмарк ONNX](#Бенчмарк-ONNX-моделей)
- [Примечания](#Примечания)

# Функции
- Реализация YOLOv11 для детектирования номерных знаков
- Подготовка датасета
- Пайплайн обучения и оценки
- Ablation study для анализа влияния:
- Различных блоков бэкбона (например, SPFF, CSPA, C3K2)
- Различных функций потерь (NWD Loss)
- Экспорт в формат ONNX

# Датасет
В проекте используется [датасет](https://huggingface.co/datasets/AY000554/Car_plate_detecting_dataset) 

Car_plate_detecting_dataset - это набор данных из примерно 25,5К изображений российских автомобилей с номерами одного типа и разметки в формате YOLO: ```class x_center y_center width height```. Этот набор данных предназначен для обучения нейронных сетей обнаружению (локализации) номера автомобиля на изображении.
Основан на датасете [AUTO.RIA Numberplate Options Dataset](https://nomeroff.net.ua/datasets/autoriaNumberplateDataset-2023-03-06.zip) из проекта [Nomeroff Net](https://nomeroff.net.ua/#).

Данные разбиты на подвыборки для обучения, тестирования и валидации:

|Типп выборки данных | Количество изображений |
| :----------------: |:----------------------:|
| train |      20505 (80%)       |
| val   |       2563 (10%)       |
| test  |       2564 (10%)       |
| all images |         25632          |

В качестве разметки файлы .txt с именем изображения, внутри которых находится разметка в формате YOLO ```class x_center y_center width height```.

# Установка
1. Клонируйте репозиторий
   ```Powershell
   git clone https://github.com/AntoxaZ18/lpr_detect.git
   cd lpr_detect
   ```
2. Установите вирутальную среду и зависимости через Poetry
   Если хотите чтобы вирутальная среда создалась в папке с проектом
   ```Powershell
   poetry config settings.virtualenvs.in-project true
   ```
   Создайте преднастроенную виртуальную среду
   ```Powershell
   poetry install
   ```
   Активируйте среду при помощи poetry (опционально)
   ```Powershell
   poetry env activate
   ```
# Обучение

# Оценка

# Ablation Study

Результаты
Результаты ablation study хранятся в папке results/ и включают:

Конфигурацию моделей в виде yaml файлов
Обученную модель в формате torch и ONNX

Данные по характеристикам моделей

|       Модель       |       val map@50       |    val map@50-95   |       GFLOPS           |   FPS on CPU(onnx)     | 
| :----------------: |:----------------------:| :----------------: |:----------------------:|:----------------------:|
| original       |      0.986       |      0.822       |      6.5       |      27.9       |
| CSPA, C3k2 1   |      0.986       |      0.804       |      5.4       |      28.4       |
| CSPA->C3K2*    |      0.986       |      0.804       |      5.1       |      31.9       |
| SPFF->MAxPool  |      0.985       |      0.792       |      4.5       |      32.4       |
| Снижение разм  |      0.985       |      0.785       |      4.2       |      35.8       |
| C3K2->conv     |      0.985       |      0.769       |      4.0       |      38.7       |
| 320 NWD loss   |      0.966       |      0.742       |      4.0       |      80+        |

- 1 original - Оригинал модель yolov11 nano
- 2 Замена тяжелого блока с2spa на c3k2 уменьшение количества каналов 1024->768 и 512->384 на внутренних слоях
- 3 SPFF->Maxpool
- 4 уменьшение количества каналов 768->512 256->192 384->256 на внутренних слоях
- 5 замена c3k2 на conv
- 6 Изменение входного изображения модели с 640x640 на 320х320 и обучение на NWD Loss

# Экспорт в ONNX
Для экспорта в формат ONNX всех моделей, получившихся в результате ablation study необходимо выполнить
--models путь к обученным моделям в формате torch
--onnx  путь куда будут сохранены экспортированные в ONNX модели

```Powershell
python export_to_onnx.py --models ./ablation --onnx ./onnx_models
```

# Бенчмарк ONNX моделей
Для запуска бенчмарка ONNX моделей на CPU выполните
--model путь к файлу модели в фомате onnx
--image изображение для бенчмарка
--batch размер батча изображений
--imsize размер изображения на входе (640 или 320)

```Powershell
python onnx_benchmark.py --model model.onnx --image test_image.jpg --imsize 640 --batch 8
```

# Примечания
Датасет, используемый в этом проекте, является пользовательским и должен быть подготовлен соответствующим образом.
Вы можете изменить data/your_dataset.yaml, чтобы адаптировать его под вашу структуру датасета.
Для более продвинутого использования обратитесь к документации YOLOv11.
